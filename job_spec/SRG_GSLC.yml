SRG_GSLC:
  required_parameters:
    - granules
  parameters:
    granules:
      default:  '""'
      api_schema:
        type: array
        minItems: 1
        maxItems: 6
        example:
          - S1A_IW_RAW__0SDV_20231229T134339_20231229T134411_051870_064437_4F42
          - S1A_IW_RAW__0SDV_20231229T134404_20231229T134436_051870_064437_5F38
        items:
          description: Name of the Level-0 Sentinel-1 scenes to process
          type: string
          pattern: "^S1[AB]_IW_RAW"
          minLength: 67
          maxLength: 67
          example: S1A_IW_RAW__0SDV_20231229T134404_20231229T134436_051870_064437_5F38
    bucket_prefix:
      default:  '""'
  validators: []
  cost_profiles:
    DEFAULT:
      cost: 1.0
  tasks:
    - name: ''
      image: ghcr.io/asfhyp3/hyp3-srg
      command:
        - ++process
        - back_projection
        - --gpu
        - --bucket
        - '!Ref Bucket'
        - --bucket-prefix
        - Ref::bucket_prefix
        - Ref::granules
      timeout: 10800
      vcpu: 1
      memory: 31500
      secrets:
        - EARTHDATA_USERNAME
        - EARTHDATA_PASSWORD
  compute_environment:
    name: SrgGslc
    instance_types:
      - g4dn.xlarge
      - g4dn.2xlarge
      - g6.xlarge
    # Image ID for: /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
    ami_id: ami-0ca2af66da8e56876
    user_data_commands:
      - DRIVER_VERSION=550.54.14
      - dnf install -y kernel-devel-$(uname -r) kernel-headers-$(uname -r) kernel-modules-extra
      - curl -fSsl -O https://us.download.nvidia.com/tesla/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run
      - chmod +x NVIDIA-Linux-x86_64-$DRIVER_VERSION.run
      - ./NVIDIA-Linux-x86_64-$DRIVER_VERSION.run --tmpdir . --silent
      - rm ./NVIDIA-Linux-x86_64-$DRIVER_VERSION.run 
      - dnf install -y docker git
      - systemctl start docker
      - systemctl enable docker
      - usermod -aG docker ec2-user
      - dnf config-manager --add-repo https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo
      - dnf install -y nvidia-container-toolkit
      - nvidia-ctk runtime configure --runtime=docker
      - systemctl restart docker
      - dnf install -y git
      - dnf clean all && rm -rf /var/cache/dnf/*
      - reboot